<!DOCTYPE html public '❄'>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>YTLocal</title>
    <link href='//fonts.googleapis.com/css?family=Cabin|Lato' rel='stylesheet' type='text/css'>
    <style type="text/css">
        #content {
            margin: 0 auto;
            background-color: #ccc;
            width: 800px;
            text-align: center;
        }
        form {
            display: inline;
        }
        #q {
            width: 780px;
            outline: none;
            margin: 10px;
            box-sizing: border-box;
            color: black;
            cursor: auto;
            display: inline-block;
            font: 16px arial, sans-serif;
            height: 30px;
            padding: 2px 6px;
        }
        #song_title {
            margin: 5px 10px;
            font-family: 'Cabin', serif;
            font-size: 20px;
        }
        #song_descr {
            margin: 5px 10px;
            font-family: 'Lato', serif;
            font-size: 15px;
        }
    </style>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script src="https://www.google.com/jsapi?key=ABQIAAAAUFhWyG3PCr5qQ1N1-Da58BSijuhDh6bhkVNiCWkwXm1RWNn4jxTIhy9VD42I5uMUjGdZgqjFfBxulQ" type="text/javascript"></script>
    <script type="text/javascript">
        google.load("swfobject", "2.1");

        function get_random(elem) {
            var len = elem.length,
                ran = Math.random() * len;
            if (len) {
                return elem[Math.floor(ran)];
            }
        };

        var ytplayer = null,
            track_limit = 5,
            format = 'default',
            autoplay = true,
            search_results = [],
            currently_related = [],
            api_url = 'https://gdata.youtube.com/feeds/api/videos/';

        function play_pause() {
            if (ytplayer) {
                if (ytplayer.getPlayerState() == 1) {
                    ytplayer.pauseVideo();
                } else {
                    ytplayer.playVideo();
                }
            }
        }

        function volume_up() {
            if (ytplayer) {
                var vol = ytplayer.getVolume(),
                    value = (vol + 10 > 100) ? 100 : vol + 10;
                ytplayer.setVolume(value);
            }
        }

        function volume_down() {
            if (ytplayer) {
                var vol = ytplayer.getVolume(),
                    value = (vol - 10 < 0) ? 0 : vol - 10;
                ytplayer.setVolume(value);
            }
        }

        function get_player_state() {
            if (ytplayer) {
                return ytplayer.getPlayerState();
            }
        }

        function get_song_bytes_loaded() {
            if (ytplayer) {
                return ytplayer.getVideoBytesLoaded();
            }
        }

        function get_song_bytes_total() {
            if (ytplayer) {
                return ytplayer.getVideoBytesTotal();
            }
        }

        function get_song_current_time() {
            if (ytplayer) {
                return ytplayer.getCurrentTime();
            }
        }

        function get_song_duration() {
            if (ytplayer) {
                return ytplayer.getDuration();
            }
        }

        function volume_mute() {
            if (ytplayer) {
                if (ytplayer.isMuted()) {
                    ytplayer.unMute();
                } else {
                    ytplayer.mute();
                }
            }
        }

        function seek_to(seconds) {
            if (ytplayer) {
                ytplayer.seekTo(seconds, true);
            }
        }

        function update_payer_info() {
            var pros, pros2, time_total, time_now, m, s, buf = '';
            if (ytplayer) {
                pros = (get_song_bytes_loaded() / get_song_bytes_total()) * 100;
                time_total = get_song_duration();
                time_now = get_song_current_time();
                if (time_total >= 0 && time_now >= 0) {
                    pros2 = (time_now / time_total) * 100;
                    m = Math.floor(time_now / 60);
                    s = Math.floor(time_now % 60);
                    buf = (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
                    buf = buf + " / ";
                    m = Math.floor(time_total / 60);
                    s = Math.floor(time_total % 60);
                    buf += (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
                } else {
                    pros = pros2 = 0;
                }
            }
            $('#song_time').html(buf);
        }

        function load_new_video(watch, startSeconds) {
            if (ytplayer && watch) {
                ytplayer.loadVideoById(watch, parseInt(startSeconds, 10), format);
                $.getScript(api_url + watch + '?v=2&format=5&alt=json-in-script&callback=clbk_current');
            }
        }

        function play_watch(watch) {
            location.href = '#' + watch;
            load_new_video(watch);
        }

        function search_by_title(title) {
            title = encodeURIComponent(title)
            $('#tracks').text('Searching...');
            $.getScript(api_url + '?q=' + title + '&v=2&format=5&category=Music&alt=json-in-script&callback=clbk_search');
        }

        function search_submit() {
            if($('#q').val()) {
                search_by_title($('#q').val())
            }
            return false;
        }

        function onYouTubePlayerReady(playerId) {
            ytplayer = document.getElementById('myytplayer');
            setInterval(update_payer_info, 500);
            ytplayer.addEventListener("onStateChange", "on_player_state_change");
            ytplayer.addEventListener('onError', 'on_player_error');
            if (autoplay) {
                handle_hash();
            }
        }

        function on_player_state_change(newState) {
            if (newState === 0) {
                setTimeout(function() {
                    if($('#loop:checked').length) {
                        seek_to(0);
                    } else if(currently_related) {
                        play_watch(get_random(currently_related));
                    }
                }, 1000);
            }
        }

        function on_player_error(errorCode) {
            alert('ERROR:' + errorCode);
        }

        function handle_hash() {
            var l = location.hash;
            if (l.indexOf('#') === 0 && l.substring(1)) {
                play_watch(l.substring(1))
            }
        }
        function clbk_current(data) {
            var id = data.entry.media$group.yt$videoid.$t;

            document.title = data.entry.title.$t;
            $('#song_title').html(data.entry.title.$t);
            console.log(data.entry.media$group.media$description.$t);
            $('#song_descr').html(data.entry.media$group.media$description.$t);
            $('#thumbs_up').text(data.entry.yt$rating.numLikes);
            $('#thumbs_down').text(data.entry.yt$rating.numDislikes);
            $('#view_count').text(data.entry.yt$statistics.viewCount);
            $.getScript(api_url + id + '/related?v=2&format=5&category=Music&alt=json-in-script&callback=clbk_related');
        }

        function clbk_related(data) {
            currently_related = []
            var feed = data.feed.entry;
            $('#tracks').text('');
            for (var i = 0; i < feed.length; i++) {
                var id = feed[i].media$group.yt$videoid.$t;
                $('<a/>').attr('href', '#' + id).addClass('play_me').data('id', id).text(feed[i].title.$t).append('<br>').appendTo('#tracks');
                currently_related.push(id);
                if(currently_related.length >= track_limit) {
                    break;
                }
            };
            if(currently_related.length === 0) {
                $('#tracks').text('No related tracks!')
            }
        }

        function clbk_search(data) {
            search_results = []
            var feed = data.feed.entry;
            $('#tracks').text('');
            for (var i = 0; i < feed.length; i++) {
                var id = feed[i].media$group.yt$videoid.$t;
                $('<a/>').attr('href', '#' + id).addClass('play_me').data('id', id).text(feed[i].title.$t).append('<br>').appendTo('#tracks');
                search_results.push(id);
                if(search_results.length >= track_limit) {
                    break;
                }
            };
            if(search_results.length === 0) {
                $('#tracks').text('No search results!')
            }

        }

        $(document).ready(function() {
            $(document).bind('keypress', function(e) {
                var target = (e.target && e.target.type) || 'other';
                if (target != 'text' && target != 'submit') {
                    if (e.which == 32) {
                        play_pause();
                        return false;
                    }
                }
            });
            $('a.play_me').live('click', function() {
                play_watch($(this).data('id'));
            });

            $('#search').on('submit', function(e) {
                search_submit();
                e.preventDefault();
            });

            if(localStorage) {
                $('input.check').each(function(){
                    var val = localStorage.getItem('checkbox_' + this.name) === '1';
                    $('input[name=' + this.name +']').prop('checked', val);
                }).on('change', function(){
                    localStorage.setItem('checkbox_' + this.name, this.checked?'1':'0');
                });
            }

        });
    </script>
 </head>
<body>
    <script type="text/javascript"> 
        var params = {
            allowScriptAccess: "always",
            bgcolor: "#cccccc"
        };
        var atts = { id: "myytplayer" };
        swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&playerapiid=ytplayer",
                     "ytapiplayer", "580", "434", "8", null, null, params, atts);
    </script>
    <div id="content">
        <form id='search'>
            <input id="q">
        </form>
    <div id="tracks"></div>

    <div id='song_title'></div>

    <div id="ytapiplayer"><img src="no_flash.gif" width=580 height=434></div>
    <br>
         up: <span id="thumbs_up">42164</span>
         down: <span id="thumbs_down">460</span>
         views <span id="view_count">7437000</span>
        <span id='song_time'>00:00 / 03:40</span>
        <br>
        <a href="javascript:void(0);" onclick="play_pause();">play/pause</a>
        <a href="javascript:void(0);" onclick="volume_mute();">mute/unmute</a>
        <a href="javascript:void(0);" onclick="volume_up();">up</a>
        <a href="javascript:void(0);" onclick="volume_down();">down</a>
        <label>
            Loop <input type='checkbox' class='check' name='loop' id='loop' value='1'>
        </label>

        <div id="song_descr"></div>
    </div>
  </body>
</html>
